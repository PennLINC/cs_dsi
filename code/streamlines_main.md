# Main analysis for streamlines:
Documentation for all the analysis steps *after* creating the bundle specific masks in dsi-studio for all cases. All datafiles created here will be within `/cbica/csdsi/cleaned_paper_analysis/data`

FIXING DUPLICATION BUG THAT CHENYING FOUND

Start with setting up our terminal:
```bash
cd /cbica/projects/csdsi/cleaned_paper_analysis/code/bug_fix
conda activate flywheel
trks=( Arcuate_Fasciculus_L Arcuate_Fasciculus_R Cingulum_Frontal_Parahippocampal_L Cingulum_Frontal_Parahippocampal_R Cingulum_Frontal_Parietal_L Cingulum_Frontal_Parietal_R Cingulum_Parahippocampal_L Cingulum_Parahippocampal_Parietal_L Cingulum_Parahippocampal_Parietal_R Cingulum_Parahippocampal_R Cingulum_Parolfactory_L Cingulum_Parolfactory_R Corpus_Callosum_Body Corpus_Callosum_Forceps_Major Corpus_Callosum_Forceps_Minor Corpus_Callosum_Tapetum Corticospinal_Tract_L Corticospinal_Tract_R Corticostriatal_Tract_Anterior_L Corticostriatal_Tract_Anterior_R Corticostriatal_Tract_Posterior_L Corticostriatal_Tract_Posterior_R Corticostriatal_Tract_Superior_L Corticostriatal_Tract_Superior_R Fornix_L Fornix_R Frontal_Aslant_Tract_L Frontal_Aslant_Tract_R Inferior_Fronto_Occipital_Fasciculus_L Inferior_Fronto_Occipital_Fasciculus_R Inferior_Longitudinal_Fasciculus_L Inferior_Longitudinal_Fasciculus_R Middle_Longitudinal_Fasciculus_L Middle_Longitudinal_Fasciculus_R Optic_Radiation_L Optic_Radiation_R Parietal_Aslant_Tract_L Parietal_Aslant_Tract_R Reticular_Tract_L Reticular_Tract_R Superior_Longitudinal_Fasciculus1_L Superior_Longitudinal_Fasciculus1_R Superior_Longitudinal_Fasciculus2_L Superior_Longitudinal_Fasciculus2_R Superior_Longitudinal_Fasciculus3_L Superior_Longitudinal_Fasciculus3_R Thalamic_Radiation_Anterior_L Thalamic_Radiation_Anterior_R Thalamic_Radiation_Posterior_L Thalamic_Radiation_Posterior_R Thalamic_Radiation_Superior_L Thalamic_Radiation_Superior_R Uncinate_Fasciculus_L Uncinate_Fasciculus_R Vertical_Occipital_Fasciculus_L Vertical_Occipital_Fasciculus_R ) #all tracks
```

Most of the analysis steps here need to be slightly different for each of these four analysis sections, so we're usually coding that in an if-case within each python script:
1. Retrospective data (CRASH): same-scan accuracy `retro_wthn_acc`
1. Retrospective data (CRASH): inter-scan accuracy `retro_btwn_acc`
1. Retrospective data (CRASH): inter-scan reliability `retro_btwn_rel`
1. Prospective data (Penn): within-session accuracy. `prosp_wthn_acc`

### 1. Calculate dice scores.
This first step is to just calculate the dice scores for each analysis case and create streamline specific CSVs across all participants. 
We do this in `get_dice_scores.py`
Just for this section, we add another analysis group: `retro_fulldsi_btwn_rel` to get the full DSI pair-wise reliability CSVs. 
1. `retro_fulldsi_btwn_rel`: Pairwise dice scores between sessions of the full DSI. (full DSI inter-scan reliability in paper)
1. `retro_wthn_acc`: Dice score between CS-DSI and full DSI for the **same session** (same-scan accuracy)
1. `retro_btwn_acc`: Dice score between CS-DSI and full DSI for the **pairwise sessions** (inter-scan accuracy)
1. `retro_btwn_rel `: Dice score between bundles generated by a CS-DSI scheme in **pairwise sessions** (inter-scan reliability)
1. `prosp_wthn_acc`: Dice score between CS-DSI and full DSI for the **same session** (for the prospective data)


**BUG FIX: On lines 76 and 144: Deleted lower triangle of matrix for reliability cases so that pair-wise values are not repeated.**

**EDIT: Lines 121-122: Wasn't a bug, but asserting that same-scan accuracy values were not in between-scan accuracy table**

```bash
#Bootstrap
grps=( retro_fulldsi_btwn_rel retro_wthn_acc retro_btwn_acc retro_btwn_rel prosp_wthn_acc )
for grp in "${grps[@]}"; do
mkdir -p /cbica/projects/csdsi/cleaned_paper_analysis/bug_fix/logs/get_dice_scores/${grp}
for trk in "${trks[@]}"; do
qsub -o /cbica/projects/csdsi/cleaned_paper_analysis/bug_fix/logs/get_dice_scores/${grp}/${trk}.txt -N ${grp}_${trk} -pe threaded 1-2 /cbica/projects/csdsi/cleaned_paper_analysis/code/bug_fix/run_python_grid.sh get_dice_scores.py $grp $trk
done; done
```

### 2. Make tidy data of individual tracks
"Tidy" data is made in `make_tidydata_streamlines.py` (added this script during bug-fixing). This data isn't perfectly tidy on R standards, but will help when making violin plots with plotnine. This is done on a track-level inside the script. Look at `"/cbica/projects/csdsi/cleaned_paper_analysis/bug_fix/sanity_check/"+grp+"_tidydata_trackwise.csv"` to check results. In the "Difference" column, only the following tracks are allowed to have non-zero *positive* values: `Left Vertical Occipital Fasciculus, Right Vertical Occipital Fasciculus, Left Parahippocampal Cingulum, Right Parahippocampal Cingulum, and the Left Fornix` (hopefully this is enough of a sanity check?)

```bash
grps=( retro_wthn_acc retro_btwn_acc retro_btwn_rel prosp_wthn_acc )
for grp in "${grps[@]}"; do
mkdir -p /cbica/projects/csdsi/cleaned_paper_analysis/bug_fix/logs/make_tidydata_streamlines/${grp}
python make_tidydata_streamlines.py $grp #Doesn't take too long, so doing this directly. 
done
```

### 3. Concatenate individual track tidy data to make all track tidy data
Check outputs to make sure the difference between expected rows and oberved rows is 0 for all validation metrics. 
```bash
grps=( retro_wthn_acc retro_btwn_acc retro_btwn_rel prosp_wthn_acc )
for grp in "${grps[@]}"; do
python concatenate_tracks.py $grp
done
```

### 4. Make violin plots
*Figures 6a, 6c, 7a, 9a*
```bash
grps=( retro_wthn_acc retro_btwn_acc retro_btwn_rel prosp_wthn_acc )
for grp in "${grps[@]}"; do
python make_violins_streamlines.py $grp
done
```

### 4. Permutation Testing:
Permutation testing to get p values. These results are just in the supplementary. The permutations for each case is different enough to warrant a separate script. These take about 5 minutes per track, per group. During bug fixing, CUBIC was very busy and jobs weren't being scheduled, so I just ran this directly on three different cubic terminals (one for each validation metric).
```bash
for trk in "${trks[@]}"; do
python run_python_grid.sh stats_permute_retro_wthn_acc.py streamlines $trk
done
```

**BUG FIX: Line 36 on inter-scan accuracy, to include all pairs. 8P2 instead of 8C2.**
```bash
for trk in "${trks[@]}"; do
python run_python_grid.sh stats_permute_retro_btwn_acc.py streamlines $trk
done
```

```bash
for trk in "${trks[@]}"; do
python run_python_grid.sh stats_permute_retro_btwn_rel.py streamlines $trk
done
```

#### Get summary tables for all tracks:
```bash
grps=( retro_wthn_acc retro_btwn_acc_unpaired retro_btwn_rel )
for grp in "${grps[@]}"; do
python streamlines_permutation_stats.py $grp all_tracks
done
```

### 5. Get relationships with full DSI reliability
Calculating the collinearity between CS-DSI validity metrics and full DSI reliability.
*Figures 6b, 6d, 7b, 9b*
```bash
grps=( retro_wthn_acc retro_btwn_acc retro_btwn_rel prosp_wthn_acc )
for grp in "${grps[@]}"; do
python correlate_fullDSI_rel.py $grp 
done
```

### Supplementary tables are made in `Supplementary Tables.ipynb`
